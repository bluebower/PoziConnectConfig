# Pozi Connect M1 SQL

Pozi Connect compares Council's property data with Vicmap datasets to generate a spreadsheet called the M1. The M1 contains all property and address changes from individual Victorian councils to be submitted to the Department of Environment and Primary Industries (DEPI) for updating the state-wide Vicmap property and address datasets.

The rules and processes for submitting M1s are controlled by the DEPI. The full documentation is found [here](http://www.dse.vic.gov.au/__data/assets/pdf_file/0006/150927/M1_V12_Documentation_27112012.pdf)  (PDF, 4.3 MB).

## Edit Criteria

Pozi Connect generates records to populate the M1 based on multiple comparison queries, each of which is designed to satisfy the criteria for the following 'edit codes'.

DEPI provides the following summary of the edit codes.

Edit Code | Description
:--------:|------------
**B** | Only to be used when removing a primary property from the base or retiring the whole base. Refer to the worked examples on conditions for use. 
**C** | Only updating the parcel based Council Reference number (Crefno). This edit code can be used to populate or null a Crefno. 
**E** | Updates both property and address details for a given record. It requires that the Property Details and Address – Road and Locality Information columns are populated as required. 
**P** | Updates property details for a given record. It requires that the Property Details are populated as required including propnum and Crefno (if used by LGA). If Crefno is left blank the existing CREFNO value in the parcel table will be retained. 
**S** | Updates address details for a given record. It requires that the Address – Road and Locality Information columns are populated as required including the Address – Location attributes for creating spatially located address points. 
**Z** | Only used to remove secondary addresses. It will not remove a primary distance based address. Refer to the worked examples on conditions for use. 
**A** | Only used to add a property to either create a Multi Assessment or add a further multi assessment record. 
**R** | Only used to remove a property from a Multi Assessment. The last record on a multi assessment cannot be retired.

## Preparing the Data

The following tables, used by Pozi Connect in generating the M1s, have been generated by earlier Pozi Connect extraction and processing tasks. (See the SQL files in this folder and ~Shared\SQL and {Council Name}\SQL folders for further details.)

 Table                       | Derived from                | Query
-----------------------------|-----------------------------|-------------------
 PC Vicmap Parcel            | Vicmap Parcel and Property  | ~Shared\SQL\PC Vicmap Parcel.sql
 PC Vicmap Property Address  | Vicmap Property and Address | ~Shared\SQL\PC Vicmap Property Parcel.sql
 PC Council Parcel           | Council's property system   | {Council Name}\SQL\\{Council Name} PC Council Parcel.sql
 PC Council Property Address | Council's property system   | {Council Name}\SQL\\{Council Name} PC Council Property Parcel.sql

Pozi Connect also generates supplementary tables based on the above tables that contain counts of properties in parcels, parcels in properties, etc, to assist with determining the eligibility of certain types of edits.


## Edit Code ‘C’

DEPI:
>Edit Code C is used for only updating the parcel based Council Reference number (Crefno). This edit code can be used 
to populate or null a Crefno.

Comparing Vicmap Parcel against Council Parcel based on a common `spi`:

* where Vicmap `crefno` is null and the Council `crefno` is populated, then update with the *first* Council `crefno` value

Looking at all Vicmap Parcels:

* where Vicmap `crefno` value doesn't exist in Council Parcel and...
  * there exists an alternative Council `crefno` value for that parcel, then update with the *first* Council `crefno` value
  * there is no Council `crefno` value for that parcel, then null the `crefno`

Development notes:

* so far only implemented Scenario 2
* still to implement _first only_ rule

## Edit Code ‘P’

DEPI:
>Edit Code P updates property details for a given record. It requires that the Property Details are populated as required including propnum and Crefno (if used by LGA). If Crefno is left blank the existing CREFNO value in the parcel table will be retained.

Comparing Vicmap Parcel against Council Parcel based on a common `spi` value:

* where Vicmap `propnum` is null or doesn't exist in any Council Parcel, and one or more Council records have a populated `propnum`, then update with the *first* Council `propnum` value

Looking at all Vicmap Parcels:

* where Vicmap `propnum` value doesn't exist in any Council Property, and its `spi` doesn't match any Council Property with a populated `propnum`, then null the `propnum`

Note: the second part deliberately checks for the existence of the propnum in the Council _Property Address_ table, rather than the seemingly more precise Council _Parcel_ table. Council property information is traditionally more reliable than its parcel information, so we want to check if the propnum exists at all in the property table before potentially nulling out a valid property that just isn't recorded properly by the council in its parcel table.

Development notes:

* still to implement _first_ only rule
* check logic
* output `lot_number` and `plan_number` instead of spi
* do we need to consider P edits on multi-parcel properties at all?
* exclude the nulling scenario - that will be handled by the E edit

## Edit Code ‘A’

DEPI:
>Edit Code A is only used to add a property to either create a Multi Assessment or add a further multi assessment record.

Comparing Vicmap Parcel against Council Parcel based on a common `spi` value:

* where Vicmap `propnum` is null or doesn't exist in any Council Parcel, and more than one Council parcels have a populated `propnum`, then update with the _second and subsequent_ Council `propnum` values

Notes:

- if parcel is part of single-parcel property, submit `lot_number` and `plan_number`
- if parcel is part of multi-parcel property, submit `property_pfi`
- exclude NCPR parcels

## Edit Code ‘R’

DEPI:
>Edit Code R is only used to remove a property from a Multi Assessment. The last record on a multi assessment cannot be retired.

Looking at all _multi-assessment_ Vicmap Parcels:

* where Vicmap `propnum` doesn't exist in Council Parcel with the same `spi`, and...
  * Parcel is a single-parcel property, then null the _second and any subsequent_ `propnum` values
  * Parcel is part of a multi-parcel property, and none of the parcels match any Council Parcel `propnum` values based on any of the `spi` values in the multi-parcel property, then null the _second and any subsequent_ `propnum` values

Developer notes:

- in the multi-parcel multi-assessment scenario, eliminate duplicate records retiring the same property (group by `propnum`?), while retaining useful comments
- submit `property_pfi`
- ensure only top ( num_props -1 ) records get submitted

## Edit Code ‘S’

DEPI:
>Edit Code S updates address details for a given record. It requires that the Address – Road and Locality Information columns are populated as required including the Address – Location attributes for creating spatially located address points.

Comparing primary Vicmap Property Addresses against non-secondary Council Property Addresses based on a common `propnum` value:

* where Vicmap `num_road_address` is not equal to Council `num_road_address`, then update with Council address values

Looking at all non-secondary Council Property Addresses:

* where `propnum` value does not exist in Vicmap Property and the value exists in M1_P_Edit or M1_A_Edit, then update with Council address values

Note: the use of the terminology 'non-secondary' when referring to council addresses is based on the assumption that all council addresses are "primary" _unless otherwise stated_. For any council property systems that can handle and correctly identify addresses as being secondary, the `is_primary` field of the affected records will be populated with an 'N' value.

Developer notes:

* still to add functionality to update addresses for propnums that are flogged for P or A edits

## Edit Code ‘B’



## Edit Code ‘E’

DEPI:
>Edit Code E updates both property and address details for a given record. It requires that the Property Details and Address – Road and Locality Information columns are populated as required.

Pozi Connect generally handles its property, parcel and address edits using the appropriate single-purpose edit codes (C for parcels; P, A and R for properties; S for addresses).

Only in the case when trying to null an unwanted property number will Pozi Connect use E, in order to get rid of the associated address.

Developer notes:

* get any P edits that are nulling property numbers and move them here to E edits
* ensure E edits can never be created for properties that don't already have a property number - we don't want SPEAR addresses nulled out
* ensure it's only looking at non multi-assessments

## Edit Code ‘Z’

DEPI:
>Edit code Z is only used to remove secondary addresses. It will not remove a primary distance based address.

Council property systems are generally not reliable sources of secondary address information, so Pozi Connect does not attempt to retire secondary addresses. The Z edit code is not used.

## Notes about this new version

The rules and process outline above are part of a 'second generation' of the Pozi Connect M1 logic. This new approach generates records based on separate queries designed to satisfy the criteria for each edit code.

This is fundamentally different from the 'first generation' method of generating records based on different property 'scenarios' and trying to determine the attributes, rules and edit codes afterwards.

It is expected this new approach makes the logic simpler and more transparent, and give us more control over the output. It also reduces the amount of council-specific configuration as the bulk of the processing logic is common across all councils.

## New Subdivisions

### Potential Problem

Councils can sometimes add new subdivision parcels into their property system as belonging to the existing property (ie, same propnum). If these are submitted on the M1, DEPI could merge these parcels into a single property, and lose any address information submitted via SPEAR.

### Potential Solution

Before we attempt to allocate a property number to an proposed parcel (status = P), we first check whether that same propnum is already matched to any existing property (status = A). If so, exclude this record from the M1.
